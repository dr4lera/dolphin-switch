name: Build (Nintendo Switch)

on:
  push:
    branches: [ main, master ]
    tags: [ "v*" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-switch:
    runs-on: ubuntu-latest

    # devkitPro toolchain + libnx + switch-tools preinstalled
    container:
      image: devkitpro/devkita64:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Patch ImPlot timegm for Switch
        shell: bash
        run: |
          set -euxo pipefail

          f="Externals/implot/implot/implot.cpp"

          echo "=== Showing MkGmtTime area BEFORE patch ==="
          sed -n '870,895p' "$f"

          # Replace the single line: t.S = timegm(ptm);
          perl -i -pe 's/^\s*t\.S\s*=\s*timegm\(ptm\);\s*$/#if defined(__SWITCH__)\n    \/\/ libnx\/newlib doesn\x27t provide timegm(). Treat ptm as UTC.\n    auto days_from_civil = [](int y, unsigned m, unsigned d) -> int64_t {\n        y -= m <= 2;\n        const int era = (y >= 0 ? y : y - 399) \/ 400;\n        const unsigned yoe = (unsigned)(y - era * 400);\n        const unsigned doy = (153 * (m + (m > 2 ? -3 : 9)) + 2) \/ 5 + d - 1;\n        const unsigned doe = yoe * 365 + yoe \/ 4 - yoe \/ 100 + doy;\n        return (int64_t)era * 146097 + (int64_t)doe - 719468;\n    };\n    const int y = ptm->tm_year + 1900;\n    const unsigned mon = (unsigned)(ptm->tm_mon + 1);\n    const unsigned day = (unsigned)ptm->tm_mday;\n    const int64_t days = days_from_civil(y, mon, day);\n    t.S = (time_t)(days * 86400LL + (int64_t)ptm->tm_hour * 3600LL + (int64_t)ptm->tm_min * 60LL + (int64_t)ptm->tm_sec);\n#else\n    t.S = timegm(ptm);\n#endif/sm' "$f"

          echo "=== Showing MkGmtTime area AFTER patch ==="
          sed -n '870,910p' "$f"

          # Hard fail if the exact call still exists
          if grep -q "timegm(ptm)" "$f"; then
            echo "Patch failed: timegm(ptm) still present in $f"
            exit 1
          fi

      - name: Force ImPlot submodule to master
        shell: bash
        run: |
          set -euxo pipefail

          # Git safety: Actions + containers can trigger "dubious ownership"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory /__w/dolphin-switch/dolphin-switch

          cd Externals/implot
          git fetch origin
          git checkout master
          git pull origin master
          cd ../..


      # The devkitPro container is usually minimal; ensure CMake/Ninja exist.
      - name: Install build deps
        shell: bash
        run: |
          set -euxo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              cmake ninja-build git ca-certificates
          elif command -v pacman >/dev/null 2>&1; then
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed cmake ninja git
          fi

      - name: Configure
        shell: bash
        run: |
          set -euxo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="$DEVKITPRO/cmake/Switch.cmake" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: bash
        run: |
          set -euxo pipefail
          cmake --build build -j"$(nproc)"

      - name: Package NRO(s)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p dist

          # Find produced ELFs and convert each to an NRO.
          # If your build already outputs an .nro, this will still upload it.
          mapfile -d '' elfs < <(find build -type f -name "*.elf" -print0 || true)
          mapfile -d '' nros < <(find build -type f -name "*.nro" -print0 || true)

          if [ "${#elfs[@]}" -eq 0 ] && [ "${#nros[@]}" -eq 0 ]; then
            echo "No .elf or .nro found under build/. Check your CMake targets/output names."
            exit 1
          fi

          # Convert ELFs -> NROs
          for elf in "${elfs[@]}"; do
            base="$(basename "${elf%.*}")"
            nacp="dist/${base}.nacp"
            out="dist/${base}.nro"

            # Basic metadata; change strings if you want.
            nacptool --create "${base}" "${base}" "0.0.0" "$nacp"
            elf2nro "$elf" "$out" --nacp="$nacp"
          done

          # Copy any already-built NROs too
          for nro in "${nros[@]}"; do
            cp -f "$nro" dist/
          done

          ls -lah dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: switch-build
          path: dist/*

      # Create a GitHub Release when you push a tag like v0.1.0
      - name: Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
